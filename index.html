<!DOCTYPE html>
<html>
<head>
    <title>Abbott-Smith, A Manual Greek Lexicon of the New Testament Online</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta charset="utf-8">
    <link rel="stylesheet" href="simple.css">
    <script src="parse-lexicon/greek-helpers.js"></script>
    <script defer src="parse-lexicon/AbbotSmithData.js"></script>
    <script src="parse-lexicon/AbbotSmithLexicon.js"></script>
    <script src="scripts/BibleInfo.js"></script>

</head>
<body>
<main>
    <h1>A Manual Greek Lexicon of the New Testament</h1>
    <h2>Abbott-Smith</h2>
    <center>
        <form id="searchForm">
            <svg class="search-icon" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512">
                <path d="M505 442.7L405.3 343c-4.5-4.5-10.6-7-17-7H372c27.6-35.3 44-79.7 44-128C416 93.1 322.9 0 208 0S0 93.1 0 208s93.1 208 208 208c46.3 0 92.7-16.4 128-44v16.3c0 6.4 2.5 12.5 7 17l99.7 99.7c9.4 9.4 24.6 9.4 33.9 0l28.3-28.3c9.4-9.4 9.4-24.6.1-33.9zM208 336c-70.7 0-128-57.2-128-128 0-70.7 57.2-128 128-128 70.7 0 128 57.2 128 128 0 70.7-57.2 128-128 128z"/>
            </svg>
            <input list="suggestions" type="text" autocomplete="off" id="searchTerm"
                   placeholder="Enter your search term">
            <div id="suggestions"></div>
        </form>
    </center>
    <div class="loader"></div>
    <div id="result">
        <div id="result-content"></div>
        <div id="strongs-links"></div>
        <div id="verse-popup"></div>
    </div>
    <noscript>
        <div class="javascript-disabled">
            JavaScript is disabled in your browser. Please enable it to allow the search function to work properly.
        </div>
    </noscript>
</main>
<footer>
    <p>Public domain.</br>
        The <a href="https://github.com/translatable-exegetical-tools/Abbott-Smith">source file</a> at Github.</br>
        The <a href="http://archive.org/details/manualgreeklexic00abborich">original printed book</a>.</p>
    <button id="dark-switch">Toggle dark mode</button>
</footer>

<script>
    let lexicon = null,
        domResultContent = document.getElementById("result-content"),
        domSearchInput = document.getElementById("searchTerm"),
        domStrongsLinks = document.getElementById("strongs-links");
    let ByzData = null;

    fetch("byztxt/merged/ByzantineText.json")
        .then((response) => response.json())
        .then((json) => ByzData = json);

    window.onload = function () {
        lexicon = new AbbotSmithLexicon();
        lexicon.attach(AbbotSmithData);

        document.querySelector('.loader').style.display = 'none';

        //autocomplete function
        autocomplete(lexicon);

        document.getElementById('searchForm').addEventListener('submit', function (event) {
            event.preventDefault();
            search(domSearchInput.value);
        });

        //search for any provided terms
        let urlSearchTerm = getURLParameter('search');
        if (urlSearchTerm) {
            domSearchInput.value = urlSearchTerm;
            search(urlSearchTerm);
        }
    };

    function highlightstrongs(strongstohighlight) {
        let versePopup = document.getElementById("verse-popup");
        let words = versePopup.getElementsByClassName("words")[0];
        let wordList = undefined;

        if (words === undefined || (wordList = words.getElementsByClassName("word")).length === 0) {
            return;
        }

        for (let i = 0; i < wordList.length; i++) {
            let child = wordList.item(i);
            child.classList.remove("highlighted");
            let strongs = child.dataset["strongs"];
            if (strongstohighlight.indexOf(strongs) >= 0) {
                child.classList.add("highlighted");
            }
        }
    }

    function addpopups(strongstohighlight) {
        function showverse(book, chapter, verse) {
            let versePopup = document.getElementById("verse-popup");
            versePopup.classList.remove("visible");

            if (ByzData == null) {
                window.alert("The Byzantine Text has not loaded yet.");
                return;
            }

            let bookInfo = ByzData[book];
            let verseInfo = null;
            if (bookInfo !== undefined) {
                verseInfo = bookInfo[chapter + "-" + verse];
            }

            versePopup.classList.add("visible");
            versePopup.classList.remove("minimized");
            if (!(bookInfo && verseInfo)) {
                versePopup.innerHTML = "<div>We do not have Greek data for " + book + " " + chapter + ":" + verse + "</div>";
                return;
            }

            let greekWords = verseInfo["words"];
            let strongNumbers = verseInfo["numbers"];
            let domInfo = document.createDocumentFragment();
            let domWords = document.createElement("div");
            domWords.classList.add("words");

            for (let i = 0; i < greekWords.length; i++) {
                let word = greekWords[i];
                let strongs = strongNumbers[i];
                let elem = document.createElement("span");
                elem.classList.add("word");
                elem.dataset["strongs"] = strongs;
                elem.innerHTML = word;
                elem.onclick = () => search(strongs);
                domWords.appendChild(elem);
            }

            domInfo.appendChild(domWords);

            let bottomBar = document.createElement("div");
            bottomBar.classList.add("bottomBar");

            let reference = document.createElement("div");
            reference.classList.add("popup-reference");
            reference.innerHTML = book + " " + chapter + ":" + verse;

            let minimize = document.createElement("div");
            minimize.classList.add("popup-action");
            minimize.innerHTML = "minimize";
            minimize.onclick = () => {
                versePopup.classList.toggle("minimized");
                if (versePopup.classList.contains("minimized")) {
                    minimize.innerHTML = "maximize";
                }
                else {
                    minimize.innerHTML = "minimize";
                }
            }

            let close = document.createElement("div");
            close.classList.add("popup-action");
            close.innerHTML = "close";
            close.onclick = () => {
                versePopup.classList.remove("visible");
                versePopup.innerHTML = "";
            }

            bottomBar.appendChild(reference);
            bottomBar.appendChild(minimize);
            bottomBar.appendChild(close);
            domInfo.appendChild(bottomBar);

            versePopup.replaceChildren(domInfo);

            highlightstrongs(strongstohighlight);
        }

        let refs = domResultContent.getElementsByTagName("ref");
        let refsArray = Array.from(refs);

        let addOsisRef = (r) => [r, r.getAttribute("osisRef")];
        let OsisNotNull = (refInfo) => (refInfo[1] !== null);
        let parseOsisRef = (refInfo) => [refInfo[0], BibleInfo.parseOsis(refInfo[1], null)];

        refsArray.map(addOsisRef)
            // some <ref> tags are not Scripture References
            .filter(OsisNotNull)
            .map(parseOsisRef)
            .filter(OsisNotNull)
            .forEach((refInfo) => {
                let domElem = refInfo[0];
                let referenceInfo = refInfo[1];
                domElem.classList.add("reference");
                domElem.onclick = () => showverse(referenceInfo.book, referenceInfo.chapter, referenceInfo.verse);
            });
    }

    function autocomplete(lexicon) {
        let currentFocus = -1,
            suggestions = document.getElementById('suggestions');

        domSearchInput.addEventListener('input', function () {
            currentFocus = -1; // so that first keydown shows 0th element

            // Check if the input field is empty
            if (this.value) {
                //show dropdown of suggestions
                suggestions.style.display = 'block';
            } else {
                suggestions.style.display = 'none';
                return;
            }

            suggestions.innerHTML = '';

            let searchTerm = this.value;
            let results = lexicon.getSimilar(searchTerm);

            results.forEach((result) => {
                let div = document.createElement('div');
                div.textContent = result.word;
                div.role = "option"; // Indicate that the suggestion is an option
                div.addEventListener('click', function () {
                    suggestions.style.display = "none";
                    search(this.textContent);
                });
                suggestions.appendChild(div);
            });

            if (suggestions.childElementCount > 0) {
                suggestions.childNodes[0].scrollIntoView(false);
            }
        });

        domSearchInput.addEventListener('keyup', function (e) {
            let suggestionWrapper = document.getElementById("suggestions"),
                suggestions = null;

            if (suggestionWrapper) {
                suggestions = suggestionWrapper.getElementsByTagName("div");
            }

            //don't edit currentFocus if there are no suggestions
            if (suggestions.length == 0) {
                return false;
            }

            if (e.keyCode == 40) {
                // If the arrow DOWN key is pressed, increase the currentFocus variable:
                currentFocus++;
            } else if (e.keyCode == 38) { //up
                // If the arrow UP key is pressed, decrease the currentFocus variable:
                currentFocus--;
            } else if (e.keyCode == 13) {
                e.preventDefault(); //prevent the form from being submitted,
                if (currentFocus == -1) {
                    search(this.value);
                } else {
                    suggestions[currentFocus].click();
                }

                // This is ugly and mixes function responsibilities
                suggestionWrapper.style.display = 'none';

                return null;
            }

            //wrap from last-to-first and first-to-last
            if (currentFocus < 0) {
                currentFocus = (suggestions.length - 1);
            } else if (currentFocus >= suggestions.length) {
                currentFocus = 0;
            }

            // make the current item selected and visible:

            //remove old class
            const className = "autocomplete-active";
            let selected = suggestionWrapper.getElementsByClassName(className);
            if (selected.length > 0) {
                selected[0].classList.remove(className);
            }

            suggestions[currentFocus].classList.add(className);
            suggestions[currentFocus].scrollIntoView(false);
        });
    }

    function search(searchTerm) {
        let entry = lexicon.search(searchTerm);

        if (entry == null) {
            domResultContent.innerHTML = "This search provided no results.";
            domStrongsLinks.innerHTML = "";
            return;
        }

        let prefix =
            domResultContent.innerHTML = '<span class="occurrencesNT">' + ((entry.occurrences) ? "approximately " + entry.occurrences : "unspecified number of") + ' occurrences in the Greek NT</span>';
        domResultContent.innerHTML += entry.innerHTML;

        // Update the URL with the search term
        let newUrl = updateURLParameter('search', searchTerm);
        history.pushState({}, '', newUrl);

        document.title = searchTerm + " | Abbott-Smith, A Manual Greek Lexicon of the New Testament Online";
        domSearchInput.value = entry.word;

        domStrongsLinks.innerHTML = "";
        entry.strongs.forEach((num) => {
            let href = getStrongsURL(num).toString();
            domStrongsLinks.innerHTML += "<span class='strongLink'><a href='" + href + "' target='_blank'>G" + num + "</a></span>";
        });

        addpopups(entry.strongs);
        highlightstrongs(entry.strongs);
    }

    function getURLParameter(name) {
        const urlParams = new URLSearchParams(window.location.search);
        return urlParams.get(name);
    }

    function updateURLParameter(paramName, paramValue) {
        let url = new URL(window.location.href);
        let searchParams = url.searchParams;
        searchParams.set(paramName, paramValue);
        url.search = searchParams.toString();
        return url.toString();
    }

    // toggle Dark Mode ---------------------------
    function detectColorScheme() {
        var theme = "light"; //default to light

        if (localStorage.getItem("theme")) {
            if (localStorage.getItem("theme") == "dark") {
                var theme = "dark";
            }
        } else if (!window.matchMedia) {
            return false;
        } else if (window.matchMedia("(prefers-color-scheme: dark)").matches) {
            var theme = "dark";
        }

        if (theme == "dark") {
            document.documentElement.setAttribute("data-theme", "dark");
        }
    }

    detectColorScheme();

    const toggleSwitch = document.querySelector('#dark-switch');

    function switchTheme() {
        if (document.body.classList.contains("dark-mode")) {
            localStorage.setItem('theme', 'light');
            document.body.classList.remove("dark-mode");
        } else {
            localStorage.setItem('theme', 'dark');
            document.body.classList.add("dark-mode");
        }
    }

    toggleSwitch.addEventListener('click', switchTheme, false);

    if (localStorage.getItem("theme") == "dark") {
        toggleSwitch.classList.add("active");
        document.body.classList.add("dark-mode");
    }

</script>

<script type='text/javascript'>

    const disambiguated_strongs = {"0001":["G","H"],"0007":["G","H"],"0032":["G","H"],"0039":["G","H"],"0040":["G","H"],"0068":["G","H"],"0129":["G","H"],"0165":["G","H"],"0223":["G","H","I","J"],"0256":["G","H"],"0301":["G","H"],"0367":["G","H","I"],"0435":["G","H"],"0490":["G","H"],"0630":["G","H"],"0769":["G","H"],"0770":["G","H"],"0772":["G","H"],"0863":["G","H","I"],"0906":["G","H","I","J","K"],"0921":["G","H"],"0923":["G","H"],"0928":["G","H"],"0938":["G","H"],"1050":["G","H","I","J"],"1056":["G","H"],"1081":["G","H"],"1085":["G","H"],"1086":["G","H"],"1093":["G","H","I"],"1135":["G","H"],"1487":["G","H","I","J","K","L","M"],"1492":["G","H","I"],"1662":["G","H"],"2060":["G","H"],"2197":["G","H"],"2199":["G","H"],"2216":["G","H"],"2264":["G","H","I"],"2266":["G","H"],"2269":["G","H"],"2384":["G","H"],"2385":["G","H","I","J"],"2424":["G","H","I","J","K"],"2453":["G"],"2455":["G","H","I","J","K","L","M","N"],"2459":["G","H","I"],"2491":["G","H","I","J","K"],"2495":["G","H"],"2500":["G","H","I"],"2501":["G","H","I","J","K","L","M","N","O"],"2533":["G","H"],"2536":["G","H"],"2541":["G","H","I","J"],"2542":["G","H"],"2556":["G","H"],"2564":["G","H"],"2570":["G","H"],"2577":["G","H"],"2763":["G","H"],"2787":["G","H"],"2804":["G","H"],"2839":["G","H"],"2857":["G","H"],"2962":["G","H"],"2976":["G","H","I"],"3004":["G","H"],"3017":["G","H","I","J"],"3123":["G","H"],"3128":["G","H"],"3137":["G","H","I","J","K","L","M"],"3158":["G","H"],"3161":["G","H"],"3197":["G","H"],"3558":["G","H"],"3614":["G","H"],"3624":["G","H"],"3708":["G","H"],"3754":["G","H"],"3972":["G","H"],"3985":["G","H","I"],"3986":["G","H"],"4074":["G","H","I"],"4102":["G","H"],"4151":["G","H"],"4160":["G","H","I","J"],"4245":["G","H"],"4413":["G","H","I","J"],"4504":["G","H"],"4527":["G","H"],"4528":["G","H"],"4549":["G","H"],"4569":["G","H"],"4613":["G","H","I","J","K","L","M","N","O"],"4672":["G","H"],"4690":["G","H"],"4826":["G","H","I","J","K"],"5083":["G","H","I"],"5085":["G","H"],"5259":["G","H"],"5328":["G","H","I"],"5376":["G","H","I","J","K"],"5438":["G","H"],"5442":["G","H","I"],"5456":["G","H"],"5514":["G","H"],"5564":["G","H"],"5586":["G","H"],"5590":["G","H","I","J","K"],"6202":["G","H","I"]}

    /*
    This accepts a strongs number (the actual number -- no "g" prefix),
    and returns a URL object for the link needed to search it on stepbible.org.
    strongsNumber can be supplied as int or string.
    */
    function getStrongsURL(strongsNumber) {
        strongsNumber = new String(strongsNumber);

        //stepbible.org requires a strongs number of format "G0023"
        let strongsPadded = strongsNumber.padStart(4, '0');
        let suffixes = disambiguated_strongs[strongsPadded];
        let step_URL = "";

        if (suffixes === undefined) {
            // It's a "normal" Strongs number, just do a plain search
            step_URL = "https://www.stepbible.org/?q=version=THGNT|strong=G" + strongsPadded + '&options=GVNHU';
        } else {
            // It's a disambiguated Strongs number, create
            let srchJoin = "";
            let bars = "";
            for (var x = 1; x <= suffixes.length; x++) {
                srchJoin += x + "o";
                bars += "strong=G" + strongsPadded + suffixes[x - 1] + "|";
            }

            // remove ending o and |, then generate link
            step_URL = "https://www.stepbible.org/?q=version=THGNT|srchJoin=(" + srchJoin.replace(/o$/, '') + ")|" + bars.replace(/\|$/, '');
        }
        return new URL(step_URL);
    }

</script>

<script type='text/javascript'>
    /*if ('serviceWorker' in navigator) {
        navigator.serviceWorker.register('sw.js', {scope: '.'});
    }
    window.addEventListener("load", function() {
        if (navigator.serviceWorker.controller != null) {
            navigator.serviceWorker.controller.postMessage({"command":"trimCache"});
        }
    });*/
</script>
<script defer src="https://stats.mrgreekgeek.com/script.js" data-website-id="d8e4dcbc-c1bb-4e19-875d-4888e1d24efe"></script>
</body>
</html>
